# Cyber Engine 系统架构

## 系统组件概述

Cyber Engine 由多个相互协作的组件组成，形成一个完整的智能对话系统。以下是主要组件及其功能：

### 核心服务组件

1. **WebSocket 服务**
   - 负责与客户端建立连接并维护会话
   - 接收用户消息并返回处理结果
   - 实现基于授权的简单身份认证

2. **消息处理器**
   - 解析用户输入消息格式
   - 处理特殊命令（以 "/" 开头的消息）
   - 将普通消息路由到 Ponder 核心处理

3. **Ponder 核心**
   - 对话引擎的主要处理中心
   - 自动判断输入类型并路由到相应处理流程
   - 协调指令执行和知识库查询

### 智能处理组件

1. **路由代理 (RouterAgent)**
   - 使用大语言模型分析用户输入意图
   - 将输入分类为问题或指令
   - 提供路由决策的详细信息

2. **指令处理器 (FcAgent)**
   - 解析用户指令并映射到相应功能
   - 使用函数调用执行相关操作
   - 返回结构化的指令执行结果

3. **知识库查询处理器 (QopProcess)**
   - 连接外部知识库服务
   - 检索与用户问题相关的知识
   - 利用大语言模型生成基于知识的回答

### 基础设施组件

1. **消息队列 (HMQ)**
   - 维护用户会话历史记录
   - 存储用户和助手的消息
   - 提供上下文支持

2. **任务中心**
   - 管理长时间运行的任务
   - 提供任务状态查询
   - 支持任务执行和结果返回

3. **插件系统**
   - 提供可扩展的工具功能
   - 支持注册自定义工具
   - 与指令处理器集成

## 数据流程

### 用户消息处理流程

1. 用户通过 WebSocket 发送消息
2. 消息处理器解析消息并判断类型
   - 如果是命令（/开头），执行相应命令处理
   - 否则，转发到 Ponder 核心处理
3. Ponder 核心根据消息类型选择处理路径
   - 使用路由代理分析消息类型
   - 对问题执行知识库查询
   - 对指令执行功能调用
4. 处理结果以流式方式返回给用户

### 知识库查询流程

1. 接收用户问题
2. 通过知识库连接器查询相关信息
3. 获取与问题相关的知识片段
4. 结合知识片段和大语言模型生成回答
5. 流式返回生成的回答内容

### 指令执行流程

1. 接收用户指令
2. 使用 FcAgent 解析指令内容
3. 映射到相应的功能函数
4. 执行功能并获取结果
5. 返回执行结果或创建任务

## 系统交互图

```
用户客户端 <--WebSocket--> WebSocket服务 <--> 消息处理器
                                |
                                v
                           Ponder核心
                          /         \
                         /           \
                        v             v
                   路由代理      命令处理器
                   /     \
                  /       \
                 v         v
        知识库查询处理器  指令处理器
             |               |
             v               v
          知识库服务      插件系统
```

## 扩展点

Cyber Engine 设计了多个扩展点，方便开发者进行功能扩展：

1. **插件系统**：可以通过注册新工具扩展系统功能
2. **命令系统**：可以添加新的命令处理函数
3. **客户端接入**：可以开发新的客户端，如 cyber-qbot 和 cyber-openai
4. **知识库连接**：可以替换或扩展知识库后端

## 部署拓扑

基本部署结构包括：

1. **主服务**：WebSocket 服务和核心处理组件
2. **知识库服务**：提供知识检索功能
3. **客户端适配器**：如 cyber-qbot 和 cyber-openai

高级部署可以考虑：

1. 使用负载均衡器实现多实例部署
2. 将数据存储与处理逻辑分离
3. 使用容器化技术（如 Docker）简化部署 